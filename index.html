<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹‡è€…ä¼ è¯´ï¼šå¥”å¥”çš„å‡€åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimSun', serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(45deg, #FFD700, #FF6347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 30px rgba(255, 215, 0, 0.5); }
            50% { text-shadow: 0 0 50px rgba(255, 215, 0, 0.8); }
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #FFD700, #FF6347);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .nav {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 25px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-btn.active, .nav-btn:hover {
            background: linear-gradient(45deg, #FFD700, #FF6347);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
            border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            color: #FFD700;
            margin-bottom: 25px;
            text-align: center;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        /* æˆ˜æ–—è®­ç»ƒé¡µ */
        .difficulty-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .difficulty-btn {
            padding: 10px 20px;
            border: 2px solid #FFD700;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.9);
        }

        .difficulty-btn.active {
            background: #FFD700;
            color: #0f0c29;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .word-progress {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .word-circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.7);
        }

        .word-circle.active {
            background: #FFD700;
            color: #0f0c29;
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .word-circle.completed {
            background: #4caf50;
            color: white;
        }

        .word-card {
            text-align: center;
            padding: 40px;
        }

        .word {
            font-size: 52px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .phonetic {
            font-size: 26px;
            color: #FF6347;
            margin-bottom: 25px;
            font-style: italic;
        }

        .meaning {
            font-size: 32px;
            color: #1E90FF;
            margin-bottom: 25px;
            font-weight: bold;
        }

        .example {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .pronunciation-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .pronunciation-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #FFD700, #FF6347);
            color: #0f0c29;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .pronunciation-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(255, 215, 0, 0.6);
        }

        .action-buttons {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 40px;
        }

        .action-btn {
            padding: 18px 50px;
            border: none;
            border-radius: 35px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .know-btn {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
        }

        .dont-know-btn {
            background: linear-gradient(45deg, #FF6347, #e74c3c);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        /* å‹‡è€…å‘å¯¼é¡µ */
        .ai-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .ai-tab {
            padding: 12px 25px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ai-tab.active {
            background: linear-gradient(45deg, #FFD700, #FF6347);
            color: #0f0c29;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            font-weight: bold;
        }

        .ai-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            min-height: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-box {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 80%;
        }

        .chat-message.ai {
            background: linear-gradient(45deg, #FFD700, #FF6347);
            color: #0f0c29;
            margin-right: auto;
            font-weight: bold;
        }

        .chat-message.user {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            margin-left: auto;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            outline: none;
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .chat-input input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .story-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 25px;
            border-radius: 15px;
            line-height: 1.8;
            font-size: 18px;
            min-height: 350px;
        }

        .story-word {
            background: linear-gradient(45deg, #FFD700, #FF6347);
            color: #0f0c29;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* å¥”å¥”å›¾é‰´é¡µ */
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-input, .filter-select {
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            outline: none;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            flex: 1;
        }

        .filter-select {
            flex: 0.5;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .word-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .word-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .import-section {
            margin-top: 25px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* å‡€åŒ–ä»»åŠ¡é¡µ */
        .review-queue {
            text-align: center;
            margin-bottom: 30px;
        }

        .review-count {
            font-size: 48px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
        }

        .quiz-card {
            text-align: center;
        }

        .quiz-question {
            font-size: 36px;
            margin-bottom: 40px;
            color: #FFD700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .quiz-option {
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
        }

        .quiz-option:hover {
            border-color: #FFD700;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.2);
        }

        .quiz-option.correct {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
            border-color: #4caf50;
        }

        .quiz-option.wrong {
            background: linear-gradient(45deg, #f44336, #e53935);
            color: white;
            border-color: #f44336;
        }

        /* æ‹¯æ•‘è¿›åº¦é¡µ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-number {
            font-size: 42px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            margin-top: 10px;
            font-size: 16px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 35px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-container h3 {
            color: #FFD700;
            margin-bottom: 25px;
            text-align: center;
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section h3 {
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            width: 55px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: linear-gradient(45deg, #FFD700, #FF6347);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 29px;
        }

        .loading {
            text-align: center;
            padding: 50px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="header">
            <div class="logo">âš”ï¸ å‹‡è€…ä¼ è¯´ï¼šå¥”å¥”çš„å‡€åŒ–</div>
            <div class="progress-bar">
                <div class="progress-fill" id="dailyProgress" style="width: 0%"></div>
            </div>
            <div class="nav">
                <button class="nav-btn active" onclick="showPage('group-learning')">æˆ˜æ–—è®­ç»ƒ</button>
                <button class="nav-btn" onclick="showPage('ai-assistant')">å‹‡è€…å‘å¯¼</button>
                <button class="nav-btn" onclick="showPage('word-bank')">å¥”å¥”å›¾é‰´</button>
                <button class="nav-btn" onclick="showPage('review')">å‡€åŒ–ä»»åŠ¡</button>
                <button class="nav-btn" onclick="showPage('progress')">æ‹¯æ•‘è¿›åº¦</button>
            </div>
        </div>

        <!-- æˆ˜æ–—è®­ç»ƒé¡µ -->
        <div id="group-learning" class="page active">
            <div class="card">
                <h2>é€‰æ‹©å¥”å¥”ç­‰çº§</h2>
                <div class="difficulty-selector">
                    <button class="difficulty-btn active" data-difficulty="cet4">æ™®é€šå¥”å¥”ï¼ˆå››çº§ï¼‰</button>
                    <button class="difficulty-btn" data-difficulty="cet6">ç²¾è‹±å¥”å¥”ï¼ˆå…­çº§ï¼‰</button>
                    <button class="difficulty-btn" data-difficulty="tem4">å¥”å¥”é¢†ä¸»ï¼ˆä¸“å››ï¼‰</button>
                    <button class="difficulty-btn" data-difficulty="tem8">å¥”å¥”ä¹‹ç‹ï¼ˆä¸“å…«ï¼‰</button>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="pronunciation-btn" onclick="generateNewGroup()">å¼€å§‹ç‹©çŒ</button>
                </div>
            </div>

            <div class="card" id="wordCardContainer" style="display: none;">
                <div class="word-progress" id="wordProgress"></div>
                <div class="word-card" id="wordCard">
                    <div class="word" id="currentWord"></div>
                    <div class="phonetic" id="currentPhonetic"></div>
                    <div class="meaning" id="currentMeaning"></div>
                    <div class="example" id="currentExample"></div>
                    <div class="pronunciation-controls">
                        <button class="pronunciation-btn" onclick="speakWord()">ğŸ”Š è†å¬å¥”å¥”</button>
                        <button class="pronunciation-btn" onclick="speakExample()">ğŸ“ å¥”å¥”ä½è¯­</button>
                        <select id="voiceAccent" onchange="updateVoiceSettings()">
                            <option value="en-US">ç¾éŸ³</option>
                            <option value="en-GB">è‹±éŸ³</option>
                        </select>
                        <select id="voiceRate" onchange="updateVoiceSettings()">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1.0x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2.0x</option>
                        </select>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn know-btn" onclick="markWord('know')">âœ… æˆåŠŸå‡€åŒ–</button>
                    <button class="action-btn dont-know-btn" onclick="markWord('dont-know')">â“ éœ€è¦æ”¯æ´</button>
                </div>
            </div>
        </div>

        <!-- å‹‡è€…å‘å¯¼é¡µ -->
        <div id="ai-assistant" class="page">
            <div class="card">
                <div class="ai-tabs">
                    <button class="ai-tab active" onclick="showAITab('chat')">å‘å¯¼å¯¹è¯</button>
                    <button class="ai-tab" onclick="showAITab('story')">å‹‡è€…æ—¥å¿—</button>
                    <button class="ai-tab" onclick="showAITab('dictionary')">å¥”å¥”ç™¾ç§‘</button>
                </div>
                
                <div id="ai-chat" class="ai-content">
                    <div class="chat-box" id="chatBox"></div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="å‘å‘å¯¼æ±‚åŠ©..." onkeypress="handleChatKeyPress(event)">
                        <button class="pronunciation-btn" onclick="sendChatMessage()">å‘é€</button>
                    </div>
                </div>

                <div id="ai-story" class="ai-content" style="display: none;">
                    <div class="story-box" id="storyBox">
                        <p>è¯·å…ˆå‡€åŒ–ä¸€æ‰¹å¥”å¥”ï¼Œç„¶åè®°å½•ä½ çš„å‹‡è€…æ—¥å¿—</p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="pronunciation-btn" onclick="generateStory()">ç”Ÿæˆæˆ˜æ–—æ—¥å¿—</button>
                    </div>
                </div>

                <div id="ai-dictionary" class="ai-content" style="display: none;">
                    <div class="search-filter">
                        <input type="text" class="search-input" id="dictionaryWord" placeholder="è¾“å…¥å¥”å¥”åç§°...">
                        <button class="pronunciation-btn" onclick="queryDictionary()">æŸ¥è¯¢</button>
                    </div>
                    <div id="dictionaryResult"></div>
                </div>
            </div>
        </div>

        <!-- å¥”å¥”å›¾é‰´é¡µ -->
        <div id="word-bank" class="page">
            <div class="card">
                <div class="search-filter">
                    <input type="text" class="search-input" id="searchWord" placeholder="æœç´¢å¥”å¥”..." oninput="filterWords()">
                    <select class="filter-select" id="filterCategory" onchange="filterWords()">
                        <option value="">å…¨éƒ¨ç§ç±»</option>
                        <option value="daily">æ£®æ—å¥”å¥”</option>
                        <option value="academic">é­”æ³•å¥”å¥”</option>
                        <option value="business">æš—å½±å¥”å¥”</option>
                    </select>
                    <select class="filter-select" id="filterDifficulty" onchange="filterWords()">
                        <option value="">å…¨éƒ¨ç­‰çº§</option>
                        <option value="easy">åˆçº§</option>
                        <option value="medium">ä¸­çº§</option>
                        <option value="hard">é«˜çº§</option>
                    </select>
                </div>
                <div class="word-grid" id="wordGrid"></div>
                <div class="import-section">
                    <h3 style="color: #FFD700; margin-bottom: 15px;">å¯¼å…¥å¥”å¥”æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰</h3>
                    <input type="file" id="csvFile" accept=".csv" onchange="importCSV(event)" style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); color: white;">
                    <p style="margin-top: 15px; color: rgba(255,255,255,0.7); font-size: 14px;">æ ¼å¼ï¼šå¥”å¥”åç§°,ç‰¹å¾,å‡€åŒ–æ–¹æ³•,ä¹ æ€§,ç§ç±»,ç­‰çº§</p>
                </div>
            </div>
        </div>

        <!-- å‡€åŒ–ä»»åŠ¡é¡µ -->
        <div id="review" class="page">
            <div class="card">
                <div class="review-queue">
                    <div class="review-count" id="reviewCount">0</div>
                    <div style="font-size: 20px; color: rgba(255,255,255,0.8);">å¾…å‡€åŒ–å¥”å¥”</div>
                </div>
                <div id="reviewCard" class="quiz-card" style="display: none;">
                    <div class="quiz-question" id="quizQuestion"></div>
                    <div class="quiz-options" id="quizOptions"></div>
                    <div class="pronunciation-controls">
                        <button class="pronunciation-btn" onclick="speakQuizWord()">ğŸ”Š æ’­æ”¾å¥”å¥”å«å£°</button>
                    </div>
                </div>
                <div id="reviewComplete" style="text-align: center; display: none;">
                    <h2 style="color: #FFD700; margin-bottom: 15px;">ğŸ‰ ä»Šæ—¥å‡€åŒ–å®Œæˆï¼</h2>
                    <p style="font-size: 18px; color: rgba(255,255,255,0.8);">ä¸–ç•Œå› ä½ è€Œæ›´å®‰å…¨ï¼</p>
                </div>
            </div>
        </div>

        <!-- æ‹¯æ•‘è¿›åº¦é¡µ -->
        <div id="progress" class="page">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalWords">0</div>
                    <div class="stat-label">å·²å‡€åŒ–å¥”å¥”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayLearned">0</div>
                    <div class="stat-label">ä»Šæ—¥å‡€åŒ–</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayReviewed">0</div>
                    <div class="stat-label">ä»Šæ—¥ä»»åŠ¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="streakDays">0</div>
                    <div class="stat-label">å‡€åŒ–å¤©æ•°</div>
                </div>
            </div>
            <div class="chart-container">
                <h3 style="color: #FFD700; margin-bottom: 20px;">å‡€åŒ–è¶‹åŠ¿</h3>
                <canvas id="trendChart" width="400" height="200"></canvas>
            </div>
            <div class="settings-section">
                <h3 style="color: #FFD700; margin-bottom: 20px;">å‹‡è€…è®¾ç½®</h3>
                <div class="setting-item">
                    <span>æ¯æ—¥å‡€åŒ–ç›®æ ‡</span>
                    <input type="number" id="dailyGoal" value="20" min="5" max="100" style="width: 80px; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; text-align: center;">
                </div>
                <div class="setting-item">
                    <span>å‡€åŒ–æé†’</span>
                    <div class="toggle-switch active" id="reviewReminder" onclick="toggleSetting(this)"></div>
                </div>
                <div class="setting-item">
                    <span>è‡ªåŠ¨è†å¬</span>
                    <div class="toggle-switch" id="autoPronounce" onclick="toggleSetting(this)"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€é…ç½® ====================
        const API_KEY = 'sk-LaP3ofHPzUojd6JUzE9sqnbQprOeGyeXFaqe1v4rhg097kFq';
        const API_URL = 'https://api.moonshot.cn/v1/chat/completions';
        
        // å¥”å¥”éš¾åº¦æ˜ å°„
        const DIFFICULTY_MAP = {
            cet4: 'æ™®é€šå¥”å¥”ï¼ˆå››çº§å•è¯ï¼‰',
            cet6: 'ç²¾è‹±å¥”å¥”ï¼ˆå…­çº§å•è¯ï¼‰',
            tem4: 'å¥”å¥”é¢†ä¸»ï¼ˆä¸“å››å•è¯ï¼‰',
            tem8: 'å¥”å¥”ä¹‹ç‹ï¼ˆä¸“å…«å•è¯ï¼‰'
        };

        // å…¨å±€çŠ¶æ€
        let currentPage = 'group-learning';
        let currentWordGroup = [];
        let currentWordIndex = 0;
        let currentDifficulty = 'cet4';
        let db = null;
        let learnedWords = new Set();
        let todayStats = {
            learned: 0,
            reviewed: 0,
            lastDate: new Date().toDateString()
        };
        let voiceSettings = {
            accent: 'en-US',
            rate: 1
        };

        // ==================== IndexedDB åˆå§‹åŒ– ====================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('WordLearningDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    loadStats();
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('words')) {
                        const wordStore = db.createObjectStore('words', { keyPath: 'word' });
                        wordStore.createIndex('nextReview', 'nextReview', { unique: false });
                        wordStore.createIndex('difficulty', 'difficulty', { unique: false });
                        wordStore.createIndex('category', 'category', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('stats')) {
                        db.createObjectStore('stats', { keyPath: 'date' });
                    }
                    
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                    
                    if (!db.objectStoreNames.contains('learnedGroups')) {
                        db.createObjectStore('learnedGroups', { keyPath: 'id' });
                    }
                };
            });
        }

        // ==================== Kimi API è°ƒç”¨ ====================
        async function callKimi(messages, temperature = 0.7) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'kimi-k2-turbo-preview',
                        messages,
                        temperature
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('Kimi APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // ==================== é¡µé¢åˆ‡æ¢ ====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            
            currentPage = pageId;
            
            if (pageId === 'review') {
                loadReviewQueue();
            } else if (pageId === 'word-bank') {
                loadWordBank();
            } else if (pageId === 'progress') {
                updateProgressStats();
                renderChart();
            }
        }

        // ==================== æˆ˜æ–—è®­ç»ƒ ====================
        function setupDifficultySelector() {
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentDifficulty = this.dataset.difficulty;
                });
            });
        }

        async function generateNewGroup() {
            const container = document.getElementById('wordCardContainer');
            container.style.display = 'none';
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.innerHTML = '<div class="spinner"></div><p>æœå¯»å¥”å¥”ä¸­...</p>';
            document.getElementById('group-learning').appendChild(loadingDiv);
            
            try {
                // è·å–å·²å‡€åŒ–çš„å¥”å¥”ï¼Œé¿å…é‡å¤
                const learned = await getLearnedWords();
                const prompt = `è¯·ç”Ÿæˆ10ä¸ª${DIFFICULTY_MAP[currentDifficulty]}éš¾åº¦çš„è‹±è¯­å•è¯ï¼Œç”¨äºè‹±è¯­å­¦ä¹ ã€‚
è¦æ±‚ï¼š
1. å•è¯åº”è¯¥æ˜¯å¸¸ç”¨ä¸”å®ç”¨çš„
2. ä¸è¦åŒ…å«ä»¥ä¸‹å·²å­¦è¿‡çš„å•è¯ï¼š${Array.from(learned).join(',')}
3. è¿”å›JSONæ ¼å¼æ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡åŒ…å«ï¼šword, phonetic, meaning, example, category
4. categoryå¯ä»¥æ˜¯ï¼šdaily(æ—¥å¸¸), academic(å­¦æœ¯), business(å•†åŠ¡)
5. ç¡®ä¿å•è¯é€‚åˆä¸­å›½è‹±è¯­å­¦ä¹ è€…

è¿”å›æ ¼å¼ç¤ºä¾‹ï¼š
[
  {"word":"journey","phonetic":"/ËˆdÊ’ÉœËrni/","meaning":"æ—…ç¨‹","example":"Today, I started a new journey.","category":"daily"},
  ...
]`;

                const response = await callKimi([{ role: 'user', content: prompt }], 0.3);
                const words = JSON.parse(response.replace(/```json|```/g, '').trim());
                
                currentWordGroup = words.map((word, index) => ({
                    ...word,
                    id: `word-${Date.now()}-${index}`,
                    difficulty: currentDifficulty,
                    nextReview: Date.now(),
                    reviewCount: 0,
                    difficultyFactor: 1.0,
                    leitnerBox: 1
                }));
                
                currentWordIndex = 0;
                displayWordProgress();
                showCurrentWord();
                container.style.display = 'block';
                
            } catch (error) {
                alert('æœå¯»å¥”å¥”å¤±è´¥ï¼Œè¯·é‡è¯•');
                console.error(error);
            } finally {
                loadingDiv.remove();
            }
        }

        function displayWordProgress() {
            const container = document.getElementById('wordProgress');
            container.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                const circle = document.createElement('div');
                circle.className = 'word-circle';
                if (i < currentWordIndex) {
                    circle.classList.add('completed');
                    circle.textContent = 'âœ“';
                } else if (i === currentWordIndex) {
                    circle.classList.add('active');
                    circle.textContent = i + 1;
                } else {
                    circle.textContent = i + 1;
                }
                container.appendChild(circle);
            }
        }

        function showCurrentWord() {
            if (currentWordIndex >= currentWordGroup.length) {
                // æœ¬æ‰¹å®Œæˆ
                saveLearnedGroup();
                alert('æœ¬æ‰¹å¥”å¥”å·²å‡€åŒ–å®Œæˆï¼å·²è®°å½•åˆ°å¥”å¥”å›¾é‰´');
                return;
            }
            
            const word = currentWordGroup[currentWordIndex];
            document.getElementById('currentWord').textContent = word.word;
            document.getElementById('currentPhonetic').textContent = word.phonetic;
            document.getElementById('currentMeaning').textContent = word.meaning;
            document.getElementById('currentExample').textContent = word.example;
            
            displayWordProgress();
            
            // è‡ªåŠ¨å‘éŸ³
            if (document.getElementById('autoPronounce').classList.contains('active')) {
                setTimeout(() => speakWord(), 500);
            }
        }

        function speakWord() {
            const word = currentWordGroup[currentWordIndex]?.word;
            if (word) speakText(word);
        }

        function speakExample() {
            const example = currentWordGroup[currentWordIndex]?.example;
            if (example) speakText(example);
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = voiceSettings.accent;
                utterance.rate = voiceSettings.rate;
                speechSynthesis.speak(utterance);
            }
        }

        function updateVoiceSettings() {
            voiceSettings.accent = document.getElementById('voiceAccent').value;
            voiceSettings.rate = parseFloat(document.getElementById('voiceRate').value);
        }

        function markWord(status) {
            const currentWord = currentWordGroup[currentWordIndex];
            
            // æ›´æ–°éš¾åº¦å› å­
            if (status === 'know') {
                currentWord.difficultyFactor *= 0.9; // å˜å®¹æ˜“
                currentWord.reviewCount++;
            } else {
                currentWord.difficultyFactor *= 1.2; // å˜æ›´éš¾
                currentWord.leitnerBox = 1; // ç§»å…¥å›°éš¾ç®±
            }
            
            // ä¿å­˜åˆ°å¥”å¥”å›¾é‰´
            saveWordToDB(currentWord);
            
            // æ›´æ–°ç»Ÿè®¡
            if (status === 'know') {
                todayStats.learned++;
                updateDailyProgress();
            }
            
            // ä¸‹ä¸€ä¸ªå¥”å¥”
            currentWordIndex++;
            showCurrentWord();
            
            learnedWords.add(currentWord.word);
        }

        // ==================== å‹‡è€…å‘å¯¼ ====================
        function showAITab(tabName) {
            document.querySelectorAll('.ai-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.ai-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(`ai-${tabName}`).style.display = 'block';
            
            if (tabName === 'chat') {
                initAIChat();
            }
        }

        function initAIChat() {
            const chatBox = document.getElementById('chatBox');
            if (chatBox.children.length === 0) {
                addChatMessage('ai', 'å‹‡è€…ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å‘å¯¼ã€‚è¯·å…ˆå‡€åŒ–ä¸€æ‰¹å¥”å¥”ï¼Œæˆ‘ä¼šæ ¹æ®ä½ çš„æˆ˜æ–—æˆæœæä¾›å¸®åŠ©ï¼');
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addChatMessage('user', message);
            input.value = '';
            
            // è·å–å·²å‡€åŒ–å¥”å¥”
            const learnedWords = await getLearnedWords();
            const wordList = Array.from(learnedWords).slice(0, 10);
            
            const prompt = `ä½ æ˜¯ä¸€åè‹±è¯­é™ªç»ƒä¼™ä¼´ã€‚ç”¨æˆ·å·²å­¦ä¹ ä»¥ä¸‹å•è¯ï¼š${wordList.join(',')}
ç”¨æˆ·è¯´ï¼š${message}

è¯·ç”¨è‹±è¯­å›å¤ï¼Œåœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°ä½¿ç”¨è¿™äº›å•è¯ï¼ˆè‡³å°‘3ä¸ªï¼‰ï¼Œå¹¶çº æ­£ç”¨æˆ·å¯èƒ½çš„è¯­æ³•é”™è¯¯ã€‚
å›å¤è¦å‹å¥½ç®€çŸ­ï¼Œé€‚åˆè‹±è¯­å­¦ä¹ è€…ç†è§£ã€‚`;
            
            try {
                const response = await callKimi([{ role: 'user', content: prompt }]);
                addChatMessage('ai', response);
            } catch (error) {
                addChatMessage('ai', 'æŠ±æ­‰ï¼Œå‘å¯¼ä¿¡å·ä¸ç¨³å®šã€‚è¯·ç¨åå†è¯•ã€‚');
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function addChatMessage(sender, message) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.textContent = message;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function generateStory() {
            const storyBox = document.getElementById('storyBox');
            storyBox.innerHTML = '<div class="loading"><div class="spinner"></div><p>ç”Ÿæˆæˆ˜æ–—æ—¥å¿—ä¸­...</p></div>';
            
            try {
                // è·å–ä»Šæ—¥å‡€åŒ–çš„å¥”å¥”
                const todayWords = await getTodayLearnedWords();
                if (todayWords.length === 0) {
                    storyBox.innerHTML = '<p>ä»Šå¤©è¿˜æ²¡æœ‰å‡€åŒ–å¥”å¥”ï¼å…ˆå»æˆ˜æ–—å§ï¼</p>';
                    return;
                }
                
                const wordList = todayWords.slice(0, 8).map(w => `${w.word}(${w.meaning})`).join(', ');
                const prompt = `ä½ æ˜¯ä¸€åè‹±è¯­æ•™è‚²ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹å•è¯åˆ›ä½œ2-3å¥æç¬‘çŸ­æ–‡ï¼š
è¦æ±‚ï¼š
1. å¿…é¡»åŒ…å«æ‰€æœ‰æä¾›çš„å•è¯åŠå…¶ä¸­æ–‡é‡Šä¹‰ï¼ˆæ ¼å¼ï¼šå•è¯(ä¸­æ–‡)ï¼‰
2. å†…å®¹è¦å¹½é»˜æœ‰è¶£ï¼Œè®©äººå°è±¡æ·±åˆ»
3. æ¯å¥è¯éƒ½ç”¨ä¸­æ–‡ä¸ºä¸»ï¼ŒåµŒå…¥è‹±æ–‡å•è¯
4. é€‚åˆä¸­å›½è‹±è¯­å­¦ä¹ è€…ï¼Œéš¾åº¦é€‚ä¸­

å•è¯åˆ—è¡¨ï¼š${wordList}

ç¤ºä¾‹è¾“å‡ºæ ¼å¼ï¼š
"ä»Šå¤©ï¼Œæˆ‘è¸ä¸Šäº†ä¸€æ®µæ–°çš„journeyï¼ˆæ—…ç¨‹ï¼‰ï¼Œç»“æœå‘ç°è‡ªå·±å¿˜äº†å¸¦luggageï¼ˆè¡Œæï¼‰ï¼Œåªå¥½ç”¨paperï¼ˆçº¸ï¼‰åšäº†ä¸ªå‡ç®±å­ï¼"`;

                const story = await callKimi([{ role: 'user', content: prompt }], 0.8);
                storyBox.innerHTML = `<p>${story}</p>`;
                
                // é«˜äº®å¥”å¥”åç§°
                const words = todayWords.slice(0, 8);
                words.forEach(word => {
                    const regex = new RegExp(`(${word.word})`, 'g');
                    storyBox.innerHTML = storyBox.innerHTML.replace(regex, 
                        `<span class="story-word" onclick="speakText('${word.word}')">${word.word}</span>`);
                });
                
            } catch (error) {
                storyBox.innerHTML = '<p>æˆ˜æ–—æ—¥å¿—ç”Ÿæˆå¤±è´¥</p>';
            }
        }

        async function queryDictionary() {
            const word = document.getElementById('dictionaryWord').value.trim();
            if (!word) return;
            
            const resultDiv = document.getElementById('dictionaryResult');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const prompt = `è¯·è¯¦ç»†è§£é‡Šè‹±è¯­å•è¯"${word}"ï¼ŒåŒ…æ‹¬ï¼š
1. éŸ³æ ‡
2. ä¸­æ–‡é‡Šä¹‰ï¼ˆè¯¦ç»†ï¼‰
3. åŒä¹‰è¯ï¼ˆè‡³å°‘3ä¸ªï¼‰
4. åä¹‰è¯ï¼ˆè‡³å°‘2ä¸ªï¼‰
5. å®ç”¨ä¾‹å¥ï¼ˆè‡³å°‘2ä¸ªï¼‰

è¯·ç”¨æ¸…æ™°æ˜“è¯»çš„æ ¼å¼è¿”å›ï¼Œé€‚åˆè‹±è¯­å­¦ä¹ è€…ã€‚`;
                
                const response = await callKimi([{ role: 'user', content: prompt }]);
                resultDiv.innerHTML = `<pre style="white-space: pre-wrap; line-height: 1.8; color: rgba(255,255,255,0.9);">${response}</pre>`;
                
            } catch (error) {
                resultDiv.innerHTML = '<p style="color: rgba(255,255,255,0.7);">æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¥”å¥”åç§°</p>';
            }
        }

        // ==================== å‡€åŒ–ä»»åŠ¡ ====================
        async function loadReviewQueue() {
            const now = Date.now();
            const words = await getWordsForReview(now);
            
            document.getElementById('reviewCount').textContent = words.length;
            
            if (words.length > 0) {
                startReview(words);
            } else {
                document.getElementById('reviewCard').style.display = 'none';
                document.getElementById('reviewComplete').style.display = 'block';
            }
        }

        async function getWordsForReview(timestamp) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['words'], 'readonly');
                const store = transaction.objectStore('words');
                const index = store.index('nextReview');
                
                const words = [];
                const request = index.openCursor(IDBKeyRange.upperBound(timestamp));
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        words.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(words);
                    }
                };
                
                request.onerror = () => reject(request.error);
            });
        }

        async function startReview(words) {
            const reviewCard = document.getElementById('reviewCard');
            reviewCard.style.display = 'block';
            document.getElementById('reviewComplete').style.display = 'none';
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªå¥”å¥”
            const word = words[Math.floor(Math.random() * words.length)];
            window.currentReviewWord = word;
            
            document.getElementById('quizQuestion').textContent = word.word;
            
            // ç”Ÿæˆé€‰é¡¹
            const options = await generateQuizOptions(word);
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';
            
            options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'quiz-option';
                div.textContent = option;
                div.onclick = () => selectOption(div, option === word.meaning, index);
                optionsContainer.appendChild(div);
            });
        }

async function generateQuizOptions(word) {
     const prompt = `ä¸ºè‹±è¯­å•è¯"${word.word}"ç”Ÿæˆ4ä¸ªé€‰é¡¹ï¼ˆåŒ…å«æ­£ç¡®ç­”æ¡ˆï¼‰ï¼Œç”¨äºè‹±è¯­æµ‹è¯•é¢˜ã€‚
è¦æ±‚ï¼š
- é€‰é¡¹ä¸ºä¸­æ–‡é‡Šä¹‰
- 1ä¸ªæ­£ç¡®ç­”æ¡ˆï¼ˆè¯¥å•è¯çš„å‡†ç¡®ä¸­æ–‡æ„æ€ï¼š${word.meaning}ï¼‰
- 3ä¸ªå¹²æ‰°é¡¹éœ€ä¸æ­£ç¡®ç­”æ¡ˆåœ¨å«ä¹‰ã€è¯æ€§æˆ–ç”¨æ³•ä¸Šç›¸ä¼¼ï¼Œå…·æœ‰è¿·æƒ‘æ€§
- æ‰€æœ‰é€‰é¡¹éƒ½å¿…é¡»æ˜¯ä¸­æ–‡
- è¿”å›JSONæ ¼å¼ï¼š{"correct":"æ­£ç¡®é‡Šä¹‰","options":["é€‰é¡¹1","é€‰é¡¹2","é€‰é¡¹3","é€‰é¡¹4"]}
- é€‰é¡¹é¡ºåºéšæœº

å•è¯ï¼š${word.word} (æ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰æ˜¯ï¼š${word.meaning})`;

    try {
        const response = await callKimi([{ role: 'user', content: prompt }], 0.3);
        const data = JSON.parse(response.replace(/```json|```/g, '').trim());
        
        // æ‰“ä¹±é€‰é¡¹é¡ºåº
        const options = [...data.options];
        for (let i = options.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];
        }
        
        return options;
    } catch (error) {
        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ä¸­æ–‡
        return [
            word.meaning,
            'ä¸€ä¸ªç›¸ä¼¼ä½†é”™è¯¯çš„é‡Šä¹‰',
            'å¦ä¸€ä¸ªæ··æ·†é€‰é¡¹',
            'å†ä¸€ä¸ªå¹²æ‰°é¡¹'
        ];
    }
}
        function selectOption(element, isCorrect, optionIndex) {
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(opt => opt.onclick = null); // ç¦ç”¨ç‚¹å‡»
            
            if (isCorrect) {
                element.classList.add('correct');
                handleCorrectAnswer();
            } else {
                element.classList.add('wrong');
                options.forEach(opt => {
                    if (opt.textContent === window.currentReviewWord.meaning) {
                        opt.classList.add('correct');
                    }
                });
                handleWrongAnswer();
            }
            
            setTimeout(() => {
                loadReviewQueue();
            }, 2000);
        }

        function speakQuizWord() {
            if (window.currentReviewWord) {
                speakText(window.currentReviewWord.word);
            }
        }

        async function handleCorrectAnswer() {
            const word = window.currentReviewWord;
            word.reviewCount++;
            word.difficultyFactor = Math.max(0.5, word.difficultyFactor * 0.9);
            word.nextReview = calculateNextReview(word);
            
            await saveWordToDB(word);
            todayStats.reviewed++;
            updateDailyProgress();
        }

        async function handleWrongAnswer() {
            const word = window.currentReviewWord;
            word.difficultyFactor = Math.min(2.5, word.difficultyFactor * 1.3);
            word.leitnerBox = Math.min(5, word.leitnerBox + 1);
            word.nextReview = Date.now() + (24 * 60 * 60 * 1000); // 24å°æ—¶åå¼ºåˆ¶å‡€åŒ–
            
            await saveWordToDB(word);
            
            // ç”Ÿæˆå¼ºåŒ–æç¤º
            alert(`éœ€è¦åŠ å¼ºè®­ç»ƒï¼å»ºè®®ï¼šæŠŠ"${word.word}"å†™åœ¨é­”æ³•å·è½´ä¸Šï¼Œç»ƒä¹ 3æ¬¡å‡€åŒ–ã€‚`);
        }

        function calculateNextReview(word) {
            const days = Math.pow(2.5, word.reviewCount - 1) * word.difficultyFactor;
            return Date.now() + (days * 24 * 60 * 60 * 1000);
        }

        // ==================== å¥”å¥”å›¾é‰´ ====================
        async function loadWordBank() {
            const words = await getAllWords();
            renderWordGrid(words);
        }

        function getAllWords() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['words'], 'readonly');
                const store = transaction.objectStore('words');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function renderWordGrid(words) {
            const grid = document.getElementById('wordGrid');
            grid.innerHTML = '';
            
            words.forEach(word => {
                const item = document.createElement('div');
                item.className = 'word-item';
                
                const mastery = Math.min(100, (word.reviewCount * 20));
                const masteryColor = mastery > 80 ? '#4caf50' : mastery > 50 ? '#ff9800' : '#f44336';
                
                item.innerHTML = `
                    <div class="word-header">
                        <div>
                            <strong style="color: #FFD700; font-size: 18px;">${word.word}</strong> 
                            <span style="color: #FF6347;">${word.phonetic}</span>
                            <div style="font-size: 14px; color: #1E90FF; margin-top: 5px;">å‡€åŒ–ï¼š${word.meaning}</div>
                        </div>
                        <div style="color: ${masteryColor}; font-weight: bold; font-size: 18px;">${mastery}%</div>
                    </div>
                    <div style="margin-top: 15px; font-size: 14px; color: rgba(255,255,255,0.7);">
                        å‡€åŒ–${word.reviewCount}æ¬¡ | ä¸‹æ¬¡é­é‡ï¼š${formatDate(word.nextReview)}
                    </div>
                `;
                
                grid.appendChild(item);
            });
        }

        function filterWords() {
            const searchTerm = document.getElementById('searchWord').value.toLowerCase();
            const category = document.getElementById('filterCategory').value;
            const difficulty = document.getElementById('filterDifficulty').value;
            
            getAllWords().then(words => {
                const filtered = words.filter(word => {
                    const matchesSearch = !searchTerm || 
                        word.word.toLowerCase().includes(searchTerm) ||
                        word.meaning.toLowerCase().includes(searchTerm);
                    const matchesCategory = !category || word.category === category;
                    const matchesDifficulty = !difficulty || word.difficulty === difficulty;
                    
                    return matchesSearch && matchesCategory && matchesDifficulty;
                });
                
                renderWordGrid(filtered);
            });
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                const words = lines.slice(1).map((line, index) => {
                    const [word, phonetic, meaning, example, category, difficulty] = line.split(',');
                    return {
                        word,
                        phonetic,
                        meaning,
                        example,
                        category,
                        difficulty,
                        nextReview: Date.now(),
                        reviewCount: 0,
                        difficultyFactor: 1.0,
                        leitnerBox: 1
                    };
                });
                
                for (const word of words) {
                    await saveWordToDB(word);
                }
                
                alert(`æˆåŠŸå¯¼å…¥${words.length}ä¸ªå¥”å¥”æ•°æ®ï¼`);
                loadWordBank();
            };
            
            reader.readAsText(file);
        }

        // ==================== æ‹¯æ•‘è¿›åº¦ ====================
        function updateProgressStats() {
            getAllWords().then(words => {
                document.getElementById('totalWords').textContent = words.length;
                document.getElementById('todayLearned').textContent = todayStats.learned;
                document.getElementById('todayReviewed').textContent = todayStats.reviewed;
                document.getElementById('streakDays').textContent = calculateStreak();
            });
        }

        function calculateStreak() {
            const stats = JSON.parse(localStorage.getItem('learningStats') || '{}');
            let streak = 0;
            let currentDate = new Date();
            
            while (true) {
                const dateStr = currentDate.toDateString();
                if (stats[dateStr] && (stats[dateStr].learned > 0 || stats[dateStr].reviewed > 0)) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function renderChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const stats = JSON.parse(localStorage.getItem('learningStats') || '{}');
            
            const dates = [];
            const learned = [];
            const reviewed = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                
                dates.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                learned.push(stats[dateStr]?.learned || 0);
                reviewed.push(stats[dateStr]?.reviewed || 0);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'å‡€åŒ–å¥”å¥”',
                        data: learned,
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'å‡€åŒ–ä»»åŠ¡',
                        data: reviewed,
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function toggleSetting(element) {
            element.classList.toggle('active');
        }

        // ==================== æ•°æ®å­˜å‚¨ ====================
        function saveWordToDB(word) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['words'], 'readwrite');
                const store = transaction.objectStore('words');
                const request = store.put(word);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getLearnedWords() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['words'], 'readonly');
                const store = transaction.objectStore('words');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const words = new Set(request.result.map(w => w.word));
                    resolve(words);
                };
                request.onerror = () => reject(request.error);
            });
        }

        function getTodayLearnedWords() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['words'], 'readonly');
                const store = transaction.objectStore('words');
                const today = new Date().toDateString();
                
                const words = [];
                const request = store.openCursor();
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const word = cursor.value;
                        const wordDate = new Date(word.nextReview - (24 * 60 * 60 * 1000)).toDateString();
                        if (wordDate === today && word.reviewCount === 1) {
                            words.push(word);
                        }
                        cursor.continue();
                    } else {
                        resolve(words);
                    }
                };
                
                request.onerror = () => reject(request.error);
            });
        }

        function saveLearnedGroup() {
            const transaction = db.transaction(['learnedGroups'], 'readwrite');
            const store = transaction.objectStore('learnedGroups');
            store.put({
                id: `group-${Date.now()}`,
                words: currentWordGroup.map(w => w.word),
                date: Date.now(),
                difficulty: currentDifficulty
            });
        }

        function updateDailyProgress() {
            const dailyGoal = parseInt(document.getElementById('dailyGoal').value);
            const progress = Math.min(100, ((todayStats.learned + todayStats.reviewed) / dailyGoal) * 100);
            document.getElementById('dailyProgress').style.width = progress + '%';
            
            // ä¿å­˜ç»Ÿè®¡
            const today = new Date().toDateString();
            const stats = JSON.parse(localStorage.getItem('learningStats') || '{}');
            if (!stats[today]) stats[today] = { learned: 0, reviewed: 0 };
            stats[today].learned = todayStats.learned;
            stats[today].reviewed = todayStats.reviewed;
            localStorage.setItem('learningStats', JSON.stringify(stats));
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('zh-CN');
        }

        function loadStats() {
            const today = new Date().toDateString();
            const stats = JSON.parse(localStorage.getItem('learningStats') || '{}');
            
            if (stats[today]) {
                todayStats = { ...todayStats, ...stats[today], lastDate: today };
            }
            
            updateDailyProgress();
        }

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            setupDifficultySelector();
            updateDailyProgress();
            
            // è¯·æ±‚é€šçŸ¥æƒé™
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // æ£€æŸ¥å‡€åŒ–æé†’
            setInterval(() => {
                if (document.getElementById('reviewReminder').classList.contains('active')) {
                    checkReviewReminder();
                }
            }, 60 * 1000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        });

        async function checkReviewReminder() {
            const words = await getWordsForReview(Date.now());
            if (words.length > 0) {
                new Notification('å‹‡è€…ä¼ è¯´', {
                    body: `æœ‰${words.length}åªå¥”å¥”éœ€è¦å‡€åŒ–ï¼`,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">âš”ï¸</text></svg>'
                });
            }
        }
    </script>
</body>
</html>
